<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Chem Tutor - v2.0 (Optimized)</title>
    <link rel="stylesheet" href="./styles/tokens.css" />
    <link rel="stylesheet" href="./styles/globals.css" />
    
    <!-- React via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Markdown + Sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <!-- RDKit JS with fallbacks -->
    <script>
      // RDKit loading with multiple fallbacks
      let rdkitLoadAttempts = 0;
      const maxAttempts = 3;
      
      function loadRDKit() {
        rdkitLoadAttempts++;
        console.log(`Attempting to load RDKit (attempt ${rdkitLoadAttempts}/${maxAttempts})`);
        
        const cdnSources = [
          'https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js',
          'https://cdn.jsdelivr.net/npm/@rdkit/rdkit/dist/RDKit_minimal.js',
          'https://cdnjs.cloudflare.com/ajax/libs/rdkit/2023.03.1/RDKit_minimal.js'
        ];
        
        const currentSource = cdnSources[(rdkitLoadAttempts - 1) % cdnSources.length];
        console.log(`Trying RDKit from: ${currentSource}`);
        
        const script = document.createElement('script');
        script.src = currentSource;
        script.onload = () => {
          setTimeout(() => {
            if (window.RDKit) {
              console.log('RDKit loaded successfully from:', currentSource);
              window.RDKitReady = true;
              window.RDKit.init().then(() => {
                console.log('RDKit initialized successfully');
                window.RDKitInitialized = true;
              }).catch(err => {
                console.error('RDKit initialization failed:', err);
                window.RDKitInitialized = false;
              });
            } else {
              console.error('RDKit object not found after loading');
              retryRDKit();
            }
          }, 1000);
        };
        script.onerror = () => {
          console.error(`Failed to load RDKit from: ${currentSource}`);
          retryRDKit();
        };
        document.head.appendChild(script);
      }
      
      function retryRDKit() {
        if (rdkitLoadAttempts < maxAttempts) {
          console.log(`Retrying RDKit load in 2 seconds...`);
          setTimeout(loadRDKit, 2000);
        } else {
          console.error('All RDKit loading attempts failed');
          window.RDKitReady = false;
          window.RDKitInitialized = false;
          document.addEventListener('DOMContentLoaded', () => {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
              position: fixed; top: 10px; right: 10px; 
              background: #fee; border: 1px solid #fcc; 
              padding: 10px; border-radius: 4px; 
              color: #c33; font-family: Arial, sans-serif;
              z-index: 10000; max-width: 300px;
            `;
            errorDiv.innerHTML = `
              <strong>Chemistry Diagrams Unavailable</strong><br>
              RDKit library failed to load. Diagrams may not display properly.<br>
              <button onclick="this.parentElement.remove()" style="margin-top: 5px;">Dismiss</button>
            `;
            document.body.appendChild(errorDiv);
          });
        }
      }
      
      window.addEventListener('load', loadRDKit);
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- Load utility modules first -->
    <script src="./utils/nepaliHelpers.js"></script>
    <script src="./services/apiService.js"></script>
    
    <!-- Load component modules -->
    <script src="./components/ConfirmModal.js"></script>
    <script src="./components/ComposerArea.js"></script>
    <script src="./components/MessageList.js"></script>
    <script src="./components/Sidebar.js"></script>
    <script src="./components/MainPane.js"></script>
    <script src="./components/AppShell.js"></script>

    <!-- Main application script -->
    <script type="text/babel">
      const { useState, useEffect } = React;

      // Main App component
      function App() {
        const [isLoading, setIsLoading] = useState(true);
        const [error, setError] = useState(null);

        useEffect(() => {
          // Test API connection on startup
          const testConnection = async () => {
            try {
              await apiService.testConnection();
              console.log('API connection successful');
            } catch (err) {
              console.warn('API connection failed:', err);
              setError('Unable to connect to server. Some features may not work.');
            } finally {
              setIsLoading(false);
            }
          };

          testConnection();
        }, []);

        if (isLoading) {
          return (
            <div style={{
              display: 'flex',
              justifyContent: 'center',
              alignItems: 'center',
              height: '100vh',
              flexDirection: 'column',
              gap: '20px'
            }}>
              <div className="thinking">
                <span className="spinner" />
                <span className="thinking-text">Loading Chem Tutor...</span>
              </div>
            </div>
          );
        }

        return (
          <div>
            {error && (
              <div style={{
                position: 'fixed',
                top: '10px',
                left: '50%',
                transform: 'translateX(-50%)',
                background: '#fef3c7',
                border: '1px solid #f59e0b',
                padding: '12px 20px',
                borderRadius: '8px',
                color: '#92400e',
                zIndex: 1000,
                maxWidth: '500px',
                textAlign: 'center'
              }}>
                {error}
                <button 
                  onClick={() => setError(null)}
                  style={{
                    marginLeft: '10px',
                    background: 'none',
                    border: 'none',
                    color: '#92400e',
                    cursor: 'pointer',
                    fontSize: '16px'
                  }}
                >
                  Ã—
                </button>
              </div>
            )}
            <AppShell />
          </div>
        );
      }

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
